"use strict";angular.module("factoryng").factory("Pouchyng",["$q","$timeout","Yng","yngutils",function(a,b,c,d){return function(a,b,e){function f(a){return a.$id=a._id,a}function g(){return q.allDocs({include_docs:!0}).then(function(a){a.rows.forEach(function(a){a.doc.$id=a.id,p.push(a.doc)})})}function h(a){a&&405!==a.status&&p.error(a)}function i(a){p.error(a)}function j(){return q.on("error",i),q.info().then(function(a){t=q.changes({since:a.update_seq,live:!0}),k();var b=g(),c={live:!0},d=p.url+"/"+p.name;return r=q.replicate.to(d,c,h),s=q.replicate.from(d,c,h),b})}function k(){q.on("create",p.applyFactory(l)).on("update",p.applyFactory(m)).on("delete",p.applyFactory(n))}function l(a){p.createDoc(f(a.doc))}function m(a){var b=f(a.doc),c=p.get(b.$id);c&&(b.$priority!==c.$priority?p.moveDoc(b):p.updateDoc(b))}function n(a){p.removeDoc(a.doc._id)}function o(){r.cancel(),s.cancel(),t.cancel()}var p=new c(a,b,e);p.copyApi(this);var q=null,r=null,s=null,t=null;this.provider=function(){return q},this.bind=function(a){return q?p.bindModel(a):(q=new PouchDB(p.name),j().then(function(){return p.sortIfNeeded(),p.bindModel(a)}))},this.create=function(a){return p.setPriorityIfNeeded(a),q.post(a).then(function(b){return a.$id=b.id,a._id=b.id,a._rev=b.rev,p.push(a),a})},this.update=function(a){a._id=a.$id;var b=d.clone(a);return delete b.$id,q.put(b).then(function(b){return a._rev=b.rev,p.set(a),a})},this.remove=function(a){var b=p.toId(a),c=p.get(b);return q.remove(c).then(function(){return p.remove(b)})},this.setPriority=function(a,b){var c=p.toId(a),e=p.get(c);e.$priority=b,e._id=e.$id;var f=d.clone(e);return delete f.$id,q.put(f).then(function(a){return e._rev=a.rev,p.moveDoc(e),e})},this.destroy=function(a){return o(),a?p.destroy():q.destroy().then(function(){return p.destroy()})}}}]);