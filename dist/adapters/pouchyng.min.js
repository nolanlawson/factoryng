"use strict";angular.module("factoryng").factory("Pouchyng",["$q","$timeout","Yng","yngutils",function(a,b,c,d){return function(a,b,e){function f(a){return a.$id=a._id,a}function g(){return p.allDocs({include_docs:!0}).then(function(a){a.rows.forEach(function(a){a.doc.$id=a.id,o.push(a.doc)})})}function h(){}function i(){}function j(){p.info(function(a,b){p.changes({since:b.update_seq,live:!0}),k()});var a=g(),b={live:!0},c=o.url+"/"+o.name;return p.replicate.to(c,b,h),p.replicate.from(c,b,h),a}function k(){p.on("error",i).on("create",o.applyFactory(l)).on("update",o.applyFactory(m)).on("delete",o.applyFactory(n))}function l(a){o.createDoc(f(a.doc))}function m(a){var b=f(a.doc),c=o.get(b.$id);c&&(b.$priority!==c.$priority?o.moveDoc(b):o.updateDoc(b))}function n(a){o.removeDoc(a.doc._id)}var o=new c(a,b,e);o.copyApi(this);var p=null;this.provider=function(){return p},this.bind=function(a){return p?o.bindModel(a):(p=new PouchDB(o.url+"/"+o.name),j().then(function(){return o.sortIfNeeded(),o.bindModel(a)}))},this.create=function(a){return o.setPriorityIfNeeded(a),p.post(a).then(function(b){return a.$id=b.id,a._id=b.id,a._rev=b.rev,o.push(a),a})},this.update=function(a){a._id=a.$id;var b=d.clone(a);return delete b.$id,p.put(b).then(function(b){return a._rev=b.rev,o.set(a),a})},this.remove=function(a){var b=o.toId(a),c=o.get(b);return p.remove(c).then(function(){return o.destroy(b)})},this.setPriority=function(a,b){var c=o.toId(a),e=o.get(c);e.$priority=b,e._id=e.$id;var f=d.clone(e);return delete f.$id,p.put(f).then(function(a){return e._rev=a.rev,o.moveDoc(e),e})},this.destroy=function(){return p.destroy()}}}]);