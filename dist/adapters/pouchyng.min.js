"use strict";angular.module("factoryng").factory("Pouchyng",["$q","$timeout","Yng","yngutils",function(a,b,c,d){return function(b,e,f){function g(a){return a.$id=a._id,a}function h(){return r.allDocs({include_docs:!0}).then(function(b){var c=[];return b.rows.forEach(function(a){a.doc.$id=a.id,c.push(q.createDoc(a.doc))}),a.all(c)})}function i(a){a&&405!==a.status&&q.error(a)}function j(a){q.error(a)}function k(){return r.info().then(function(a){u=r.changes({since:a.update_seq,live:!0}),l();var b=h(),c={live:!0},d=q.url+"/"+q.name;return s=r.replicate.to(d,c,i),t=r.replicate.from(d,c,i),b})}function l(){r.on("create",q.applyFactory(m)).on("update",q.applyFactory(n)).on("delete",q.applyFactory(o))}function m(a){q.createDoc(g(a.doc))}function n(a){var b=g(a.doc),c=q.get(b.$id);c?b.$priority!==c.$priority?q.moveDoc(b):q.updateDoc(b):q.createDoc(b)}function o(a){q.removeDoc(a.doc._id)}function p(){s.cancel(),t.cancel(),u.cancel()}var q=new c(b,e,f);q.copyApi(this);var r=null,s=null,t=null,u=null;this.provider=function(){return r},this.bind=function(a){return r?q.bindModel(a):(r=new PouchDB(q.name+"_"+q.nextId()),r.on("error",j),k().then(function(){return q.sortIfNeeded(),q.bindModel(a)}))},this.create=function(a){return q.setPriorityIfNeeded(a),r.post(a).then(function(b){return a.$id=b.id,a._id=b.id,a._rev=b.rev,q.push(a),a})},this.update=function(a){a._id=a.$id;var b=d.clone(a);return delete b.$id,r.put(b).then(function(b){return a._rev=b.rev,q.set(a),a})},this.remove=function(a){var b=q.toId(a),c=q.get(b);return r.remove(c).then(function(){return q.remove(b)})},this.setPriority=function(a,b){var c=q.toId(a),e=q.get(c);e.$priority=b,e._id=e.$id;var f=d.clone(e);return delete f.$id,r.put(f).then(function(a){return e._rev=a.rev,q.moveDoc(e),e})},this.destroy=function(a){return p(),a?q.destroy():r.destroy().then(function(){return q.destroy()})}}}]);