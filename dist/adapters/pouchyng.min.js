"use strict";angular.module("factoryng").factory("PouchyngCommon",["$q","$timeout","Yng","yngutils",function(a,b,c,d){return function(e,f,g){function h(a){a&&m.yng.error(a)}function i(){m.yng.emit("uptodate")}function j(a){return function(){return m.map().then(function(){return m.yng.sortIfNeeded(),m.yng.bindModel(m.yng.scope).then(a.resolve)})}}function k(){return m.db.info().then(function(b){var c=a.defer();m.changes=m.db.changes({since:b.update_seq,live:!0}),m.registerListeners();var d={live:!0},e=m.yng.url+"/"+m.yng.name;return m.to=m.db.replicate.to(e,d,h),m.from=m.db.replicate.from(e,d,h).once("uptodate",j(c)).on("uptodate",i).once("error",j(c)).on("complete",i),c.promise})}function l(){var a=new PouchDB(m.yng.url+"/"+m.yng.name);return d.doAndOnce(function(){return a.destroy()},"destroyed",a)}var m=this;this.yng=new c(e,f,g),this.db=null,this.to=null,this.from=null,this.changes=null,this.provider=function(){return m.db},this.bound=function(){return m.db?!0:!1},this.bind=function(a){return m.bound()?m.yng.bindModel(a):(m.db=new PouchDB(m.yng.name+"_"+m.yng.nextId()),m.db.setMaxListeners(20),m.yng.scope=a,m.db.on("error",m.yng.error),b(function(){return k()}))},this.cancel=function(){m.changes&&m.changes.cancel(),m.to&&m.to.cancel(),m.from&&m.from.cancel()},this.destroy=function(b){m.cancel();var c=d.doAndOnce(function(){return m.db.destroy()},"destroyed",this.db),e=[c];return b||e.push(l()),a.all(e).then(function(){return m.yng.destroy()})},this.copyApi=function(a){m.yng.copyApi(a);var b=["provider","bound","bind","destroy"];d.copyFns(b,m,a)}}}]),angular.module("factoryng").factory("Pouchyng",["$q","$timeout","Yng","yngutils","PouchyngCommon",function(a,b,c,d,e){return function(a,c,f){function g(a){return a.$id=a._id,a}function h(a){k.yng.createDoc(g(a.doc))}function i(a){var b=g(a.doc),c=k.yng.get(b.$id);c?b.$priority!==c.$priority?k.yng.moveDoc(b):k.yng.updateDoc(b):k.yng.createDoc(b)}function j(a){k.yng.removeDoc(a.doc._id)}var k=new e(a,c,f);k.copyApi(this),k.map=function(){return k.db.allDocs({include_docs:!0}).then(function(a){a.rows.forEach(function(a){a.doc.$id=a.id,k.yng.push(a.doc)})})},k.registerListeners=function(){var a=j;k.db.on("create",h).on("update",i).on("delete",a)},this.create=function(a){return b(function(){return k.yng.setPriorityIfNeeded(a),k.db.post(a).then(function(b){return a.$id=b.id,a._id=b.id,a._rev=b.rev,k.yng.push(a),a})})},this.update=function(a){return b(function(){a._id=a.$id;var b=d.clone(a);return delete b.$id,k.db.put(b).then(function(b){return a._rev=b.rev,k.yng.set(a),a})})},this.remove=function(a){return b(function(){var b=k.yng.toId(a),c=k.yng.get(b);return k.db.remove(c).then(function(){return k.yng.remove(b)})})},this.setPriority=function(a,c){return b(function(){var b=k.yng.toId(a),e=k.yng.get(b);e.$priority=c,e._id=e.$id;var f=d.clone(e);return delete f.$id,k.db.put(f).then(function(a){return e._rev=a.rev,k.yng.moveDoc(e),e})})}}}]);