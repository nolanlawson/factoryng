"use strict";angular.module("factoryng").factory("DeltaPouchyng",["$q","$timeout","Yng","yngutils",function(a,b,c,d){return function(a,b,e){function f(){return o.all().then(function(a){for(var b in a)delete a[b]._rev,n.push(a[b])})}function g(){}function h(){}function i(){return o.info().then(function(a){o.changes({since:a.update_seq,live:!0}),j();var b=f(),c={live:!0},d=n.url+"/"+n.name;return o.replicate.to(d,c,g),o.replicate.from(d,c,g),b})}function j(){o.on("error",h),o.deltaInit(),o.delta.on("create",n.applyFactory(k)).on("update",n.applyFactory(l)).on("delete",n.applyFactory(m))}function k(a){delete a._rev,n.createDoc(a)}function l(a){delete a._rev;var b=n.get(a.$id),c=o.merge(b,a);c.$priority!==b.$priority?n.moveDoc(c):n.updateDoc(c)}function m(a){n.removeDoc(a)}var n=new c(a,b,e);n.copyApi(this);var o=null;this.provider=function(){return o},this.bind=function(a){return o?n.bindModel(a):(o=new PouchDB(n.url+"/"+n.name),i().then(function(){return n.sortIfNeeded(),n.bindModel(a)}))},this.create=function(a){return n.setPriorityIfNeeded(a),o.save(a).then(function(b){return a.$id=b.$id,n.push(a),a})},this.update=function(a){var b=n.get(a.$id);return o.saveChanges(b,a).then(function(c){var d=o.merge(b,c);return n.set(d),a})},this.remove=function(a){return o.delete(a).then(function(a){return n.destroy(a.$id)})},this.setPriority=function(a,b){var c=n.toId(a),e=n.get(c),f=d.clone(e);return f.$priority=b,o.saveChanges(e,f).then(function(){return n.moveDoc(f),e})},this.cleanup=function(){return o.cleanup()},this.destroy=function(){return o.destroy()}}}]);