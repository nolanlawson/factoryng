"use strict";angular.module("factoryng").factory("PouchyngCommon",["$q","$timeout","Yng","yngutils",function(a,b,c,d){return function(e,f,g){function h(a){a&&o.yng.error(a)}function i(){o.yng.emit("uptodate")}function j(a){return function(){return o.map().then(function(){return o.yng.sortIfNeeded(),o.yng.bindModel(o.yng.scope).then(a.resolve)})}}function k(a){var b={since:a.update_seq,live:!0};b=d.merge(b,d.get(o.yng.props,"changes","opts")),o.changes=o.db.changes(b)}function l(a){var b={live:!0},c=b,e=o.yng.url+"/"+o.yng.name;b=d.merge(b,d.get(o.yng.props,"to","opts")),c=d.merge(c,d.get(o.yng.props,"from","opts")),o.to=o.db.replicate.to(e,b,h),o.from=o.db.replicate.from(e,c,h).once("uptodate",j(a)).on("uptodate",i).once("error",j(a)).on("complete",i)}function m(){return o.db.info().then(function(b){var c=a.defer();return k(b),o.registerListeners(),l(c),c.promise})}function n(){var a=new PouchDB(o.yng.url+"/"+o.yng.name);return d.doAndOnce(function(){return a.destroy()},"destroyed",a)}var o=this;this.yng=new c(e,f,g);var p={opts:{filter:function(a){return 0!==a._id.indexOf("_design")}}};this.yng.props={changes:p,to:p,from:p},this.db=null,this.to=null,this.from=null,this.changes=null,this.db=new PouchDB(o.yng.name+"_"+o.yng.nextId()),this.provider=function(){return o.db},this.bind=function(a){return o.yng.bound()?o.yng.bindModel(a):(o.db.setMaxListeners(20),o.yng.scope=a,o.db.on("error",o.yng.error),b(function(){return m()}))},this.cancel=function(){o.changes&&o.changes.cancel(),o.to&&o.to.cancel(),o.from&&o.from.cancel()},this.destroy=function(b){o.cancel();var c=d.doAndOnce(function(){return o.db.destroy()},"destroyed",this.db),e=[c];return b||e.push(n()),a.all(e).then(function(){return o.yng.destroy()})},this.copyApi=function(a){o.yng.copyApi(a);var b=["provider","bind","destroy"];d.copyFns(b,o,a)}}}]),angular.module("factoryng").factory("DeltaPouchyng",["$q","$timeout","Yng","yngutils","PouchyngCommon",function(a,b,c,d,e){return function(a,c,f){function g(a){delete a._rev,j.yng.createDoc(a)}function h(a){delete a._rev;var b=j.yng.get(a.$id),c=j.db.merge(b,a);c.$priority!==b.$priority?j.yng.moveDoc(c):j.yng.updateDoc(c)}function i(a){j.yng.removeDoc(a)}var j=new e(a,c,f);j.copyApi(this),j.map=function(){return j.db.all().then(function(a){d.forEach(a,function(a){delete a._rev,j.yng.push(a)})})},j.registerListeners=function(){var a=i;j.db.deltaInit(),j.db.delta.on("create",g).on("update",h).on("delete",a)},this.create=function(a){return b(function(){return j.yng.setPriorityIfNeeded(a),j.db.save(a).then(function(b){return a.$id=b.$id,j.yng.push(a),a})})},this.update=function(a){return b(function(){var b=j.yng.get(a.$id);return j.db.saveChanges(b,a).then(function(c){var d=j.db.merge(b,c);return j.yng.set(d),a})})},this.remove=function(a){return b(function(){return j.db.delete(a).then(function(a){return j.yng.remove(a.$id)})})},this.setPriority=function(a,c){return b(function(){var b=j.yng.toId(a),e=j.yng.get(b),f=d.clone(e);return f.$priority=c,j.db.saveChanges(e,f).then(function(){return j.yng.moveDoc(f),e})})},this.cleanup=function(){return j.db.cleanup()}}}]);