"use strict";angular.module("factoryng").factory("DeltaPouchyng",["$q","$timeout","Yng","yngutils",function(a,b,c,d){return function(b,e,f){function g(){return q.all().then(function(b){var c=[];for(var d in b)delete b[d]._rev,c.push(p.createDoc(b[d]));return a.all(c)})}function h(a){a&&405!==a.status&&p.error(a)}function i(a){p.error(a)}function j(){return q.info().then(function(a){t=q.changes({since:a.update_seq,live:!0}),k();var b=g(),c={live:!0},d=p.url+"/"+p.name;return r=q.replicate.to(d,c,h),s=q.replicate.from(d,c,h),b})}function k(){q.deltaInit(),q.delta.on("create",p.applyFactory(l)).on("update",p.applyFactory(m)).on("delete",p.applyFactory(n))}function l(a){delete a._rev,p.createDoc(a)}function m(a){delete a._rev;var b=p.get(a.$id),c=q.merge(b,a);c.$priority!==b.$priority?p.moveDoc(c):p.updateDoc(c)}function n(a){p.removeDoc(a)}function o(){r.cancel(),s.cancel(),t.cancel()}var p=new c(b,e,f);p.copyApi(this);var q=null,r=null,s=null,t=null;this.provider=function(){return q},this.bind=function(a){return q?p.bindModel(a):(q=new PouchDB(p.name+"_"+p.nextId()),q.on("error",i),j().then(function(){return p.sortIfNeeded(),p.bindModel(a)}))},this.create=function(a){return p.setPriorityIfNeeded(a),q.save(a).then(function(b){return a.$id=b.$id,p.push(a),a})},this.update=function(a){var b=p.get(a.$id);return q.saveChanges(b,a).then(function(c){var d=q.merge(b,c);return p.set(d),a})},this.remove=function(a){return q.delete(a).then(function(a){return p.remove(a.$id)})},this.setPriority=function(a,b){var c=p.toId(a),e=p.get(c),f=d.clone(e);return f.$priority=b,q.saveChanges(e,f).then(function(){return p.moveDoc(f),e})},this.cleanup=function(){return q.cleanup()},this.destroy=function(a){return o(),a?p.destroy():q.destroy().then(function(){return p.destroy()})}}}]);